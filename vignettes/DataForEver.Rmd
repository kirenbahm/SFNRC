---
title: 'Exploring DataForEver data'
subtitle: ''
output: 
  pdf_document: 
    latex_engine: pdflatex
vignette: >
  %\VignetteIndexEntry{DataForEver}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[UTF-8]{inputenc}
mainfont: FreeMono
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, echo=FALSE}
if(!require(knitr)){
  install.packages("knitr", repos='http://cran.us.r-project.org')
}
if(!require(rmarkdown)){
  install.packages("rmarkdown", repos='http://cran.us.r-project.org')
}
if(!require(plyr)){
  install.packages("plyr", repos='http://cran.us.r-project.org')
}
if(!require(reshape2)){
  install.packages("reshape2", repos='http://cran.us.r-project.org')
}
if(!require(ggplot2)){
  install.packages("ggplot2", repos='http://cran.us.r-project.org')
}
if(!require(scales)){
  install.packages("scales", repos='http://cran.us.r-project.org')
}

# then load the package:
library(knitr)
library(rmarkdown)
library(plyr)
library(reshape2)
library(ggplot2)
library(scales)
library(SFNRC)

knitr::opts_chunk$set(echo = TRUE, comment=NA)
```

\vspace{12pt}
\vspace{12pt}

## 1. Introduction

First and foremost, the `SFNRC` R package provides a simple, streamlined means of interacting with the DataForEver hydrology and water quality databases from within an analytical programming envrionment (RStudio). Additional tools are also included in the package, including:

- APIs for the South Florida Water Management District's DBHYDRO database

- A function to process data collected by the Miami-Dade Department of Environmental and Resources Management in preparation for merging it with DataForEver data

- A responsive tool for spatial interpolation of data

- Utility functions to calculate annual geometric means, label seasons and water years, and similar rudimentary tasks.

This vignette demonstrates some of the functionality of the `SFNRC` R package. 

But before demonstrating the package's capabilities, it is important to highlight some critical limitations of the `SFNRC` R package. The DataForEver APIs can only be used on Linux machines connected to the SFNRC's internal network. When DataForEver's data are opened up to the general public, the capabilities in this R package will be adapted to provide broader access to these world-class databases. Another important aspect to draw attention to is the construction and use of BASH shell scripts by the DataForEver API functions. This dependence on BASH is the reason the APIs only work on Linux operating systems.


\vspace{3mm}\hrule
\vspace{12pt}

**Keywords:** data

\vspace{12pt}
\vspace{12pt}

```{r, echo = FALSE, include=FALSE}
# if the NitrogenUptake2016 package isn't installed, use devtools to do so:
# devtools::install_github("troyhill/NitrogenUptake2016", build_vignettes = TRUE)

# set some constants
todaysDate <- substr(as.character(Sys.time()), 1, 10)
core.area <- pot.m2 <- 0.00801185 # mesocosm surface area (m2)
top.vol   <- core.area * 0.05 * 1e6 # cm3 in core: top 5 cm only
pointSize <- 2 # for ggplot graphics
pd <- pd2 <- position_dodge(1.2)
pd3 <- position_dodge(0.8)
grayColor <- 0.55
fig2Col   <- "gray55"


```

\vspace{12pt}
\vspace{12pt}


**2. Automated access to DataForEver**
\vspace{12pt}

Users can search for stations in the DataForEver databases:

```{r stn_query, include=TRUE, echo=TRUE}
head(getStn(query = "s33"))
```
\vspace{12pt}

Users can also query the parameters available for each station in the DataForEver hydrology database, using parameter and/or station names as constraints:

```{r stn_query2, include=TRUE, echo=TRUE}
head(getDataTypes(parameter = "salinity"))


head(getDataTypes(stn = "S333"))
```



\vspace{12pt}
\vspace{12pt}

**3. Downloading DataForEver data**
\vspace{12pt}

Using `SFNRC` to download DataForEver data is very straightforward. The water quality database is accessed using the function `getWQ()`:


```{r wq, include=TRUE, echo=FALSE, results = "hide"}
# identify desired stations and water quality parameters
stations   <- c("S333", "S12A")
wqParams   <- c("PHOSPH|NITROGEN|AMMONI|SUSPENDED|TURBIDITY")
dat <- getWQ(stns = stations, target_analytes = wqParams)
```

```{r wq_print, include=TRUE, echo=TRUE}
head(dat)
```

\vspace{12pt}

The `SFNRC` R package can also be used to download data from the DataForEver hydrology database using a function called `getHydro()`. The `data_shape` argument reshapes data from long to wide form to facilitate a broad range of end-user analyses.


```{r hydro_get_data, include=TRUE, echo=FALSE}
hydroParams <- c("flow", "head_water")

### by default, data are in "long" format, with one row per value (a unique row for every date-station-parameter combination):
hyd.long  <- getHydro(stns = stations, parameter_list = hydroParams)

### but data can also be retrieved in "wide" (one row per date-station) or "really_wide" (one row per date) forms, enabling more rapid comparison between stations and/or parameters
hyd.wide  <- getHydro(stns = stations, parameter_list = hydroParams, data_shape = "wide")
hyd.vwide <- getHydro(stns = stations, parameter_list = hydroParams, data_shape = "really_wide")

```


```{r hydro_show, include=TRUE, echo=TRUE}
head(hyd.long) # one row for every date-station-parameter combination

head(hyd.wide) # one row for every date-station combination

head(hyd.vwide) # one row for every date

```



\vspace{12pt}
\vspace{12pt}

Merging water quality and hydrology data is a routine task that is automated by `SFNRC`. Instead of navigating the two databases and then figuring out how to merge the two datasets, water quality data can be downloaded at the same time as flow/hydrology data by setting `getWaterQuality = TRUE` in a call to `getHydro()`. To reduce the number of columns in the returned dataset, it is recommended that water quality parameters be specified manually in this workflow, because the returned dataset will have two columns per parameter (returning the MDL and the value).


```{r hydro_get_data2, include=TRUE, echo=FALSE}
### simultaneously download hydrology and water quality data:
hyd.wq <- getHydro(stns = stations, parameter_list = hydroParams, 
                   getWaterQuality = TRUE, 
                   target_analytes = wqParams) # set water quality parameters here

```


```{r hydro_show_merged, include=TRUE, echo=TRUE}
head(hyd.wq)

```




\vspace{12pt}
\vspace{12pt}


```{r hydro_show2, include=TRUE, echo=TRUE}

# 
# # find stations and parameters
# bsc.stns <- dfe.data.types(stn = "BISC|BB")
# unique(bsc.stns$parameter)
# stns <- as.character(unique(bsc.stns[bsc.stns$parameter %in% "salinity", "stn"]))
# 
# # get data
# paramsToGet <- c("salinity", "surface_temperature", "bottom_temperature", "oxygen_solubility")
# bsc      <- dfe.hydro(stns = stns, parameter_list = paramsToGet)
# bsc.wide <- dfe.hydro(stns = stns, parameter_list = paramsToGet, data_shape = "wide")

```


```{r Figure 1 (Data In Brief), fig.width = 6, fig.height = 4, message = FALSE, include=FALSE, echo=FALSE}

```



